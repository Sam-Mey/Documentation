# 设置工作进程数，通常设置为CPU核心数的两倍，以充分利用多核处理器
worker_processes auto;

# 设置events块，用于定义Nginx与系统之间的事件模型
events {
    # 设置每个工作进程可以处理的最大连接数
    worker_connections 1024;
}

http {
    # 设置日志格式，其中的$remote_addr和$upstream_addr分别表示客户端IP和后端服务器IP
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    '"$upstream_addr"';

    # 设置访问日志存放的路径
    access_log /var/log/nginx/access.log main;

    # 设置错误日志存放的路径
    error_log /var/log/nginx/error.log;

    # 设置MIME类型，用于识别不同的文件类型
    include /etc/nginx/mime.types;

    # 设置默认的MIME类型，当无法识别文件类型时使用
    default_type application/octet-stream;

    # 设置服务端发送的响应头Server信息
    server_tokens off;

    # 设置FastCGI缓存路径
    fastcgi_cache_path /tmp/nginx_cache levels=1:2 keys_zone=my_cache:10m inactive=60m;

    # 定义服务器块，用于处理来自客户端的请求
    server {
        # 监听HTTP端口80
        listen 80;
        # 监听HTTPS端口443，并启用SSL
        listen 443 ssl;

        # 配置SSL证书文件的路径
        ssl_certificate /etc/nginx/certs/your_domain.crt;
        ssl_certificate_key /etc/nginx/certs/your_domain.key;
        # 如果需要，可以添加SSL证书链文件的路径
        # ssl_trusted_certificate /etc/nginx/certs/your_domain.ca_bundle.crt;

        # 配置SSL协议和密码套件
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:10m;
        ssl_session_tickets off;
        ssl_stapling on;
        ssl_stapling_verify on;

        # 添加伪静态规则
        location / {
            try_files $uri $uri/ /index.php?$args;
        }

        # 设置网站根目录
        root /var/www/html;

        # 设置索引文件的名称
        index index.php index.html index.htm;

        # 配置PHP文件的处理
        location ~ \.php$ {
            # 设置FastCGI服务地址和端口
            fastcgi_pass php:9000;
            # 配置FastCGI参数
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            # 启用FastCGI缓存
            fastcgi_cache my_cache;
            fastcgi_cache_valid 200 60m;
            # 关闭FastCGI缓存时使用
            # fastcgi_no_cache $no_cache;
            # fastcgi_cache_bypass $no_cache;
        }

        # 配置phpMyAdmin的访问
        location /phpmyadmin {
            alias /usr/share/phpmyadmin;
            index index.php;
        }

        # 配置phpMyAdmin的PHP文件处理
        location ~ ^/phpmyadmin/(.+\.php)$ {
            alias /usr/share/phpmyadmin/$1;
            # 配置FastCGI服务地址和端口
            fastcgi_pass php:9000;
            # 配置FastCGI参数
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $request_filename;
        }

        # 配置静态资源的缓存时间
        location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml)$ {
            expires 30d;
        }

        # 配置favicon.ico的访问
        location = /favicon.ico {
            log_not_found off;
            access_log off;
        }

        # 配置robots.txt的访问
        location = /robots.txt {
            allow all;
            log_not_found off;
            access_log off;
        }

        # 配置访问权限
        location ~ /\. {
            deny all;
        }
    }
}
